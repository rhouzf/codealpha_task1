---
- name: Update and upgrade apt packages
  apt:
    update_cache: yes
    upgrade: dist

- name: Install Docker
  apt:
    name: docker.io
    state: present

- name: Start Docker service
  systemd:
        name: docker
        state: started
        enabled: yes

- name: Add user to Docker group
  user:
        name: ubuntu
        groups: docker
        append: yes
- name: Install snapd
  apt:
        name: snapd
        state: present

- name: Ensure snapd is running
  systemd:
        name: snapd
        state: started
        enabled: yes

- name: Install MicroK8s
  snap:
        name: microk8s
        state: present
        classic: yes

- name: Add user to MicroK8s group
  user:
        name: ubuntu
        groups: microk8s
        append: yes

- name: Activer l'addon DNS
  command: sudo microk8s enable dns
  become: true

- name: Démarrer MicroK8s
  command: microk8s start
  become: yes











# Mise à jour de la liste des paquets disponibles et mise à niveau des paquets installés
- name: Update and upgrade apt packages
  apt:
    update_cache: yes  # Met à jour le cache des paquets (équivalent à 'apt update')
    upgrade: dist  # Met à niveau tous les paquets vers la dernière version (équivalent à 'apt upgrade -y')

# Installation de Docker
- name: Install Docker
  apt:
    name: docker.io  # Nom du paquet Docker à installer
    state: present  # S'assure que le paquet est installé

# Démarrage du service Docker
- name: Start Docker service
  systemd:
        name: docker  # Nom du service Docker
        state: started  # Démarre le service
        enabled: yes  # Active le démarrage automatique du service au démarrage du système

# Ajout de l'utilisateur 'ubuntu' au groupe 'docker'
- name: Add user to Docker group
  user:
        name: ubuntu  # Nom de l'utilisateur
        groups: docker  # Nom du groupe
        append: yes  # Ajoute l'utilisateur au groupe s'il n'y est pas déjà

# Installation de snapd (gestionnaire de paquets Snap)
- name: Install snapd
  apt:
        name: snapd  # Nom du paquet snapd
        state: present  # S'assure que snapd est installé

# Démarrage du service snapd
- name: Ensure snapd is running
  systemd:
        name: snapd  # Nom du service snapd
        state: started  # Démarre le service
        enabled: yes  # Active le démarrage automatique du service au démarrage du système

# Installation de MicroK8s (via Snap)
- name: Install MicroK8s
  snap:
        name: microk8s  # Nom du paquet Snap MicroK8s
        state: present  # S'assure que MicroK8s est installé
        classic: yes  # Installe MicroK8s en mode "classique"

# Ajout de l'utilisateur 'ubuntu' au groupe 'microk8s'
- name: Add user to MicroK8s group
  user:
        name: ubuntu  # Nom de l'utilisateur
        groups: microk8s  # Nom du groupe
        append: yes  # Ajoute l'utilisateur au groupe s'il n'y est pas déjà

# Activation de l'addon DNS pour MicroK8s
- name: Activer l'addon DNS
  command: sudo microk8s enable dns  # Commande à exécuter pour activer l'addon
  become: true  # Exécute la commande avec les privilèges root

# Démarrage de MicroK8s
- name: Démarrer MicroK8s
  command: microk8s start  # Commande à exécuter pour démarrer MicroK8s
  become: yes  # Exécute la commande avec les privilèges root